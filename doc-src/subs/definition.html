
<h1> Escaped substitution </h1>

<p> As already hinted at in the previous section, Cubictemp understands two
basic flavours of substitution. Tags of the following form are <b>escaped</b>
substitutions:</p>

<pre>
<!--(block|cubescript)-->
@_!...!@
<!--(end)-->
</pre>

<p> Escaping at the template level provides effective protection against
@!aLink(next, "XSS vulnerabilities")!@, so this tag form should be used by
preference unless there is a real need for unescaped substitution. Escaped
substitutions are escaped <b>unless</b> the expression in the substitution tag
evaluates to an object on which the special attribute "_cubictemp_unescaped"
exists and evaluates to true.  Cubictemp blocks 

(@!aLink("blocks.html", "discussed in the next chapter")!@)

have a special attribute "_cubictemp_unescaped" which evaluates to true. The
process of escaping simply involves converting the following characters to
their corresponding HTML escape sequences: &amp;, &lt;, &gt;, &quot;, &#146;.
The &quot; (quote) character is included because it can be used to break out of
an HTML attribute value string. The &#146; (singe quote) character is included
because programmers often have to substitute text into Javascript strings when
creating dynamic web-pages. A single-quote character can be used to break out
of a Javascript string, and inject malicious code. </p>

<p> Lets consider some concrete examples. </p>

<!--(block|cubescript|pySyntax)-->
import cubictemp
x = "<H1>foo</H1>"
t = cubictemp.Template("@_!x!@", x = x)
print t
<!--(end)-->

Prints:

<!--(block|htmlSyntax)-->
&lt;H1&gt;foo&lt;/H1&gt;
<!--(end)-->

Whereas:


<!--(block|cubescript|pySyntax)-->
import cubictemp

class X:
    _cubictemp_unescaped = True
    def __str__(self):
        return "<H1>foo</H1>"

t = cubictemp.Template("@_!x!@", x = X())
print t
<!--(end)-->

Prints:

<!--(block|htmlSyntax)-->
<H1>foo</H1>
<!--(end)-->


<h1> Unescaped Substitution </h1>

<p> The syntax

<pre>
<!--(block|cubescript)-->
$_!...!$
<!--(end)-->
</pre>

denotes an <b>un-escaped</b> substitution. Expressions using this substitution
syntax are <b>never</b> escaped. Concretely, this means that the following
program:</p>

<!--(block|cubescript|pySyntax)-->
import cubictemp
x = "<H1>foo</H1>"
t = cubictemp.Template("$_!x!$", x = x)
print t
<!--(end)-->

... will print:

<!--(block|htmlSyntax)-->
<H1>foo</H1>
<!--(end)-->



<h1> A simple rule of thumb </h1>

<p> What all this amounts to is a simple rule of thumb for avoiding XSS
problems - always use the <b>escaped</b> substitution syntax if you can. On
those rare occasions when you really need to place HTML in a substitution tag,
use the <b>un-escaped</b> syntax, but only after carefully evaluating the
application context to make sure that users cannot inject malicious data. </p>
